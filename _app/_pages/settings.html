---
layout: default
title: 设置
permalink: /settings/
desc: 设置
---

{% include amsf/core %}

<!-- Article wrapper, limit width -->
<article>

  <br>
  <nav>
    <a href="{{ '/' | relative_url }}" class="menu-button">
      <i class="material-icons md-48">toc</i><br>
        返回目录
    </a>
    <a href="/" class="menu-button">
      <i class="material-icons md-48">home</i><br>
        返回主页
    </a>
  </nav>
  <br>
  <br>
  
  <div class="warning1">警告：您正在使用一个实验性功能。由于此功能涉及到的相关标准仍在制定中，我们无法保证此功能始终可用，亦无法对因使用此功能造成的任何损失负责。使用此功能时请务必谨慎操作。</div>
  
  <div class="please-enable-javascript">
    <p>正在检查您的浏览器……</p>
    <noscript><p>检测到您禁用了 JavaScript。</p>
    <p>离线功能必须依赖 JavaScript 方可正常工作。</p>
    <p>请在浏览器设置中启用 JavaScript，然后重新加载此页面。</p></noscript>
  </div>
  
  <div class="unsupported-browser" style="display: none;">
    <p>很抱歉，您的浏览器不支持离线功能。</p>
    <p>请考虑升级或更换您所使用的浏览器。</p>
    <!--<p>支持的浏览器包括</p>-->
  </div>
  
  <div class="page-content" style="display: none;">
    
    <h2 id="clean-all-caches">已固定的图片缓存</h2>
    <p id="cache-calculating">计算中……</p>
    <p id="cache-info" style="display: none;">共 <span id="entrycount">0</span> 个项目，总大小 <span id="totalsize">0.00</span> MB</p>
    <button id="clean-cache" onclick="CleanCache(this.id)">取消固定所有缓存</button>
    
    <h2 id="cache-images">按章节固定图片缓存</h2>
    <p>您可以使用此功能预先缓存未阅读的章节。<br>
    <strong>此操作可能会产生大量流量，请确保您当前使用的网络不是按流量计费的网络。</strong></p>
    <br>
    <p>请选择章节</p>
    <button id="cache-chapter-10" onclick="CacheChapter('chapter10', this.id)">第十章</button>
  </div>
</article>
<script>
var cacheName = 'comic-cache';

window.onload = function() {
  document.querySelector('.please-enable-javascript').style.display = "none";
  if ('caches' in window && typeof(localStorage) !== "undefined") {
    document.querySelector('.page-content').style.display = "block";
    UpdateCacheInfo();
  }
  else {
    document.querySelector('.unsupported-browser').style.display = "block";
  }
}

function UpdateCacheInfo() {
  document.getElementById("cache-calculating").style.display = "block";
  document.getElementById("cache-info").style.display = "none";
  
  var entrycount = 0;
  var totalsize = 0;
  
  caches.open(cacheName).then(function(cache) {
    cache.keys().then(function(keys) {
      keys.forEach(function(request) {
        entrycount+=1;
        cache.match(request).then(function(response) {
          totalsize+=+response.headers.get('Content-Length');
          console.log("entrycount="+String(entrycount)+",keys.length="+String(keys.length));
          console.log(entrycount==keys.length);
          if (entrycount == keys.length) {
            document.getElementById("cache-calculating").style.display = "none";
            document.getElementById("cache-info").style.display = "block";
            document.getElementById("entrycount").innerHTML=keys.length;
            ts=totalsize/(1024*1024);
            document.getElementById("totalsize").innerHTML=ts.toFixed(2);
          }
        });
      });
    });
  });
}

function CleanCache(btn) {
  document.getElementById("cache-calculating").style.display = "block";
  document.getElementById("cache-info").style.display = "none";
  
  document.getElementById(btn).disabled = true;
  caches.delete(cacheName).then(function() {
    UpdateCacheInfo();
    document.getElementById(btn).disabled = false;
    alert('缓存清理完毕。');
  });
}

function CacheChapter(category, btn) { 
  caches.open(cacheName).then(function(cache) {
    fetch("{{ site.file }}/img/comic/" + category + "/manifest").then(function(response) {
      return response.json();
    }).then(function(urls) {
      document.getElementById(btn).disabled = true;
      origtext = document.getElementById(btn).innerHTML;
      document.getElementById(btn).innerHTML = "缓存中";
      
      document.getElementById("cache-calculating").style.display = "block";
      document.getElementById("cache-info").style.display = "none";
      
      cache.addAll(urls).then(function() {
        UpdateCacheInfo();
        document.getElementById(btn).disabled = false;
        document.getElementById(btn).innerHTML = origtext;
        alert('缓存成功。');
      }).catch(function(reason) {alert('缓存失败。错误信息：' + reason);});
    });
  });
}
</script>
<br>
<br>
<br>
